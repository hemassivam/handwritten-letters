<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Handwritten Letter Simulator</title>
  <link href="https://fonts.googleapis.com/css2?family=Homemade+Apple&family=Patrick+Hand&family=Reenie+Beanie&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4f1ec;
      margin: 0;
      padding: 2rem;
      display: flex;
      gap: 2rem;
    }

    .editor {
      width: 40%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    textarea {
      width: 100%;
      height: 300px;
      padding: 1rem;
      font-size: 1rem;
      resize: none;
    }

    select, button, input {
      padding: 0.6rem;
      font-size: 1rem;
    }

    .preview {
      width: 60%;
      background: #fffdf7;
      padding: 3rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      line-height: 1.8;
      font-size: 1.2rem;
      overflow-y: auto;
      transform: rotate(-0.3deg);
    }

    .paper {
      background-image: linear-gradient(#eee 1px, transparent 1px);
      background-size: 100% 2rem;
    }

    .ink-blue { color: #1a3d7c; }
    .ink-black { color: #111; }
    .ink-sepia { color: #5b4636; }
  </style>
</head>
<body>
  <div class="editor">
    <h2>Write your letter</h2>
    <textarea id="letterInput" placeholder="Dear..." oninput="renderLetter()"></textarea>

    <label>Handwriting Style</label>
    <select id="fontSelect" onchange="renderLetter()">
      <option value="'Homemade Apple', cursive">Classic Cursive</option>
      <option value="'Patrick Hand', cursive">Casual Hand</option>
      <option value="'Reenie Beanie', cursive">Loose Scribble</option>
    </select>

    <label>Ink Color</label>
    <select id="inkSelect" onchange="renderLetter()">
      <option value="ink-blue">Blue Ink</option>
      <option value="ink-black">Black Ink</option>
      <option value="ink-sepia">Sepia Ink</option>
    </select>

    <button onclick="downloadImage()">Download as Image</button>
    <button onclick="generateShareLink()">Generate Shareable Link</button>
    <input id="shareLink" readonly placeholder="Shareable link will appear here" />
  </div>

  <div id="preview" class="preview paper ink-blue"></div>

  <script>
    function randomizeText(text) {
      // Preserve readability: collapse 3+ newlines into 2
      const normalizedText = text.replace(/\n{3,}/g, "\n\n");
      const lines = normalizedText.split("\n");

      return lines.map(function(line) {
        if (line.trim() === "") return "";

        return line.split("").map(function(char) {
          if (char === " ") return " ";
          const rotate = (Math.random() - 0.5) * 1.2; // subtle rotation for readability
          return `<span style=\"display:inline-block; transform: rotate(${rotate}deg)\">${char}</span>`;
        }).join("");
      }).join("<br>");
    }

    function renderLetter() {
      const textEl = document.getElementById("letterInput");
      const fontEl = document.getElementById("fontSelect");
      const inkEl = document.getElementById("inkSelect");
      const preview = document.getElementById("preview");

      if (!textEl || !fontEl || !inkEl || !preview) return;

      preview.style.fontFamily = fontEl.value;
      preview.className = `preview paper ${inkEl.value}`;
      preview.innerHTML = randomizeText(textEl.value);
    }

    function downloadImage() {
      alert("Export to image will be implemented using canvas in the next iteration.");
    }

    function generateShareLink() {
      const text = document.getElementById("letterInput").value;
      const font = document.getElementById("fontSelect").value;
      const ink = document.getElementById("inkSelect").value;

      const payload = { t: text, f: font, i: ink };
      const encoded = btoa(encodeURIComponent(JSON.stringify(payload)));
      const url = `${window.location.origin}${window.location.pathname}?l=${encoded}`;

      const output = document.getElementById("shareLink");
      output.value = url;
      output.select();
    }

    // Restore letter from shared link if present
    (function hydrateFromURL() {
      const params = new URLSearchParams(window.location.search);
      if (!params.has('l')) return;

      try {
        const decoded = JSON.parse(decodeURIComponent(atob(params.get('l'))));
        if (decoded.t !== undefined) document.getElementById("letterInput").value = decoded.t;
        if (decoded.f !== undefined) document.getElementById("fontSelect").value = decoded.f;
        if (decoded.i !== undefined) document.getElementById("inkSelect").value = decoded.i;
        renderLetter();
      } catch (e) {
        console.warn('Invalid share link');
      }
    })();

    // Runtime sanity tests
    console.assert(typeof randomizeText === "function", "randomizeText should be defined");
    console.assert(typeof renderLetter === "function", "renderLetter should be defined");
    console.assert(typeof downloadImage === "function", "downloadImage should be defined");
    console.assert(typeof generateShareLink === "function", "generateShareLink should be defined");

    // Edge-case tests
    console.assert(randomizeText("") === "", "Empty input should return empty output");
    console.assert(randomizeText("A\nB").includes("<br>"), "Newlines should render as <br>");
    console.assert(!randomizeText("A\n\n\nB").includes("<br><br><br>"), "Excess blank lines should be collapsed for readability");
  </script>
</body>
</html>
